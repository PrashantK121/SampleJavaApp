name: BuildAndPushImage

on:
  push:
    branches: [main]

env:
  BUILD_VERSION: ''
  
jobs:
  build-and-push:
    # Specify self-hosted runner
    runs-on: self-hosted

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        repository: PrashantK121/SampleJavaApp
        token: ${{ secrets.GIT_ACCESS_TOKEN }}

    # Step 2: Setting build version
    - name: Setting build version
      shell: bash
      run: |
        #
        export BUILD_VERSION=$(cat app_build_version.txt)
        echo "app build version : $BUILD_VERSION"
        #

    # Step 2: Build the Java project
    - name: Build Java Project
      working-directory: ./HelloWorld
      run: |
          # 
           echo "Building jar ......"
           mvn clean install -DskipTests # Adjust for Gradle if needed
           echo "Jar build completed"
          #

    # Step 3: Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Step 4: Build the Docker image
    - name: Build Docker Image
      working-directory: ./HelloWorld
      run: sudo docker build -t ${{ secrets.DOCKER_USERNAME }}/my-java-app:$BUILD_VERSION .

    # Step 5: Push the Docker image to Docker Hub
    - name: Push Docker Image
      run: docker push ${{ secrets.DOCKER_USERNAME }}/my-java-app:$BUILD_VERSION
